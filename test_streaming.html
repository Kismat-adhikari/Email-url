<!DOCTYPE html>
<html>
<head>
    <title>Test Streaming Validation</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #results { margin-top: 20px; }
        .result { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .valid { background: #d4edda; }
        .invalid { background: #f8d7da; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #progress { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Test Real-Time Streaming Validation</h1>
    <button onclick="testStreaming()">Start Test (5 emails)</button>
    <div id="progress"></div>
    <div id="results"></div>

    <script>
        async function testStreaming() {
            const resultsDiv = document.getElementById('results');
            const progressDiv = document.getElementById('progress');
            resultsDiv.innerHTML = '';
            progressDiv.innerHTML = 'Starting...';

            const emails = [
                'test@gmail.com',
                'invalid-email',
                'user@yahoo.com',
                'admin@test.com',
                'hello@example.com'
            ];

            // Generate UUID for testing
            const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });

            try {
                const response = await fetch('http://localhost:5000/api/validate/batch/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': uuid
                    },
                    body: JSON.stringify({
                        emails: emails,
                        advanced: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        progressDiv.innerHTML = '✅ Complete!';
                        break;
                    }
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'result') {
                                const result = data.result;
                                const div = document.createElement('div');
                                div.className = `result ${result.valid ? 'valid' : 'invalid'}`;
                                div.innerHTML = `
                                    <strong>${result.email}</strong>: 
                                    ${result.valid ? '✅ Valid' : '❌ Invalid'}
                                    ${result.reason ? ` - ${result.reason}` : ''}
                                `;
                                resultsDiv.appendChild(div);
                                
                                progressDiv.innerHTML = `Progress: ${data.progress.current}/${data.progress.total} (${data.progress.percentage}%) - Valid: ${data.progress.valid}, Invalid: ${data.progress.invalid}`;
                            }
                        }
                    }
                }
            } catch (error) {
                progressDiv.innerHTML = '❌ Error: ' + error.message;
            }
        }
    </script>
</body>
</html>
